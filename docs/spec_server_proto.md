## Спецификация протокола Клиент-Сервер

### 1. Общие положения

*   **Транспорт:** WebSocket
*   **Формат данных:** JSON. Все сообщения между клиентом и сервером должны быть в формате JSON.
*   **Кодировка:** UTF-8

### 2. Структура сообщений

#### 2.1. Клиент -> Сервер

Сообщения от клиента к серверу представляют собой JSON-объект, который должен содержать как минимум ключ `type`. Остальные поля зависят от типа сообщения.

```json
{
  "type": "MESSAGE_TYPE",
  "...": "..."
}
```

#### 2.2. Сервер -> Клиент

Сообщения от сервера к клиенту имеют стандартизированную структуру: JSON-объект с ключом `type` и, опционально, с ключом `data`, который содержит полезную нагрузку сообщения.

```json
{
  "type": "MESSAGE_TYPE",
  "data": {
    "..."
  }
}
```

Если полезная нагрузка отсутствует, ключ `data` может быть опущен.

### 3. Валидация полей

Некоторые поля в сообщениях проходят валидацию на стороне сервера:

*   `user_name` (имя пользователя):
    *   Тип: `string`
    *   Длина: от 4 до 48 символов.
    *   Разрешенные символы: латинские буквы, цифры и `_+-=/ $%#@!?,;()[]`.
*   `room_name` (имя комнаты):
    *   Тип: `string`
    *   Длина: от 4 до 48 символов.
    *   Разрешенные символы: латинские буквы, цифры и `_+-=/ $%#@!?,;()[]`.
*   `room_uuid` (UUID комнаты):
    *   Тип: `string`
    *   Формат: UUIDv4 (например, `123e4567-e89b-12d3-a456-426614174000`).

### 4. Сообщения: Клиент -> Сервер

#### 4.1. `NEW_ROOM`

Создает новую комнату на сервере.

*   **Поля:**
    *   `type` (string): `"NEW_ROOM"`
    *   `room_name` (string): Имя создаваемой комнаты.
    *   `user_name` (string): Имя пользователя, создающего комнату. Он автоматически становится первым участником.
*   **Пример:**
    ```json
    {
      "type": "NEW_ROOM",
      "room_name": "My_Awesome_Room",
      "user_name": "Alice"
    }
    ```

#### 4.2. `JOIN_ROOM`

Присоединяет клиента к существующей комнате.

*   **Поля:**
    *   `type` (string): `"JOIN_ROOM"`
    *   `room_uuid` (string): Уникальный идентификатор комнаты для подключения.
    *   `room_name` (string): Имя комнаты (должно совпадать с именем комнаты, ассоциированной с `room_uuid`).
    *   `user_name` (string): Имя нового участника. Должно быть уникальным в пределах комнаты.
*   **Пример:**
    ```json
    {
      "type": "JOIN_ROOM",
      "room_uuid": "f81d4fae-7dec-11d0-a765-00a0c91e6bf6",
      "room_name": "My_Awesome_Room",
      "user_name": "Bob"
    }
    ```

#### 4.3. `LEAVE_ROOM`

Позволяет клиенту покинуть комнату.

*   **Поля:**
    *   `type` (string): `"LEAVE_ROOM"`
    *   `room_uuid` (string): Уникальный идентификатор комнаты.
    *   `room_name` (string): Имя комнаты.
    *   `user_name` (string): Имя пользователя, который покидает комнату.
*   **Пример:**
    ```json
    {
      "type": "LEAVE_ROOM",
      "room_uuid": "f81d4fae-7dec-11d0-a765-00a0c91e6bf6",
      "room_name": "My_Awesome_Room",
      "user_name": "Bob"
    }
    ```

#### 4.4. `FAST_ROOM_EXACT`

Быстро создать комнату или присоединиться к существующей комнате с указанными названием и UUID

*   **Поля:**
    *   `type` (string): `"FAST_ROOM_EXACT"`
    *   `room_uuid` (string): Уникальный идентификатор комнаты
    *   `room_name` (string): Название комнаты
    *   `user_name` (string): Имя пользователя, присоединеющегося к комнате
*   **Пример:**
    ```json
    {
      "type": "FAST_ROOM_EXACT",
      "room_uuid": "f81d4fae-7dec-11d0-a765-00a0c91e6bf6",
      "room_name": "My_Awesome_Room",
      "user_name": "Bob"
    }
    ```

#### 4.5. `SDP_NEW_STATE`

Отправляет WebRTC SDP (offer/answer) или ICE candidate другому участнику комнаты через сервер.

*   **Поля:**
    *   `type` (string): `"SDP_NEW_STATE"`
    *   `room_uuid` (string): Уникальный идентификатор комнаты.
    *   `room_name` (string): Имя комнаты.
    *   `user_name` (string): Имя пользователя-отправителя.
    *   `target_user` (string): Имя пользователя-получателя.
    *   `sdp_type` (string): Тип SDP данных. Допустимые значения: `"offer"`, `"answer"`, `"candidate"`.
    *   `sdp_data` (any): Данные SDP (обычно JSON-объект или строка).
*   **Пример:**
    ```json
    {
      "type": "SDP_NEW_STATE",
      "room_uuid": "f81d4fae-7dec-11d0-a765-00a0c91e6bf6",
      "room_name": "My_Awesome_Room",
      "user_name": "Alice",
      "target_user": "Bob",
      "sdp_type": "offer",
      "sdp_data": "..."
    }
    ```

### 5. Сообщения: Сервер -> Клиент

#### 5.1. `FAILED`

Отправляется клиенту в случае ошибки обработки его запроса.

*   **Полезная нагрузка (`data`):**
    *   `reason` (string): Текстовое описание ошибки.
*   **Пример:**
    ```json
    {
      "type": "FAILED",
      "data": {
        "reason": "User with this usename already in the room"
      }
    }
    ```

#### 5.2. `SUCCESS`

Отправляется в ответ на успешное выполнение действия, которое не требует возврата данных (например, `LEAVE_ROOM` или `SDP_NEW_STATE`).

*   **Полезная нагрузка (`data`):** отсутствует.
*   **Пример:**
    ```json
    {
      "type": "SUCCESS"
    }
    ```

#### 5.3. `ROOM_CREATED`

Отправляется клиенту, который успешно создал новую комнату (в ответ на `NEW_ROOM` или, возможно, `FAST_ROOM_EXACT`).

*   **Полезная нагрузка (`data`):**
    *   `room_uuid` (string): Сгенерированный сервером уникальный идентификатор для новой комнаты.
*   **Пример:**
    ```json
    {
      "type": "ROOM_CREATED",
      "data": {
        "room_uuid": "a4d2b7c6-3e1f-4f0e-8c9a-2b1d0e6f7a8b"
      }
    }
    ```

#### 5.4. `ROOM_JOINED`

Отправляется клиенту, который успешно присоединился к комнате (в ответ на `JOIN_ROOM` или, возможно, `FAST_ROOM_EXACT`).

*   **Полезная нагрузка (`data`):**
    *   `room_members` (list[string]): Список имен всех участников, уже находящихся в комнате (включая самого клиента).
*   **Пример:**
    ```json
    {
      "type": "ROOM_JOINED",
      "data": {
        "room_members": ["Alice", "Bob"]
      }
    }
    ```

#### 5.5. `ROOM_NEW_MEMBER`

Рассылается всем участникам комнаты (кроме нового), когда к комнате присоединяется новый пользователь.

*   **Полезная нагрузка (`data`):**
    *   `name` (string): Имя нового участника.
*   **Пример:**
    ```json
    {
      "type": "ROOM_NEW_MEMBER",
      "data": {
        "name": "Charlie"
      }
    }
    ```

#### 5.6. `ROOM_MEMBER_LEFT`

Рассылается всем оставшимся участникам комнаты, когда один из пользователей ее покидает.

*   **Полезная нагрузка (`data`):**
    *   `name` (string): Имя покинувшего участника.
*   **Пример:**
    ```json
    {
      "type": "ROOM_MEMBER_LEFT",
      "data": {
        "name": "Bob"
      }
    }
    ```

#### 5.7. `SDP_STATE`

Пересылается сервером целевому клиенту (указанному в `target_user` в исходном сообщении `SDP_NEW_STATE`).

*   **Полезная нагрузка (`data`):**
    *   `type` (string): Тип SDP данных (`"offer"`, `"answer"`, `"candidate"`).
    *   `from` (string): Имя пользователя, который отправил эти данные.
    *   `sdp_data` (any): Данные SDP.
*   **Пример:**
    ```json
    {
      "type": "SDP_STATE",
      "data": {
        "type": "offer",
        "from": "Alice",
        "sdp_data": "..."
      }
    }
    ```