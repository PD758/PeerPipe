# Спецификация протокола Клиент-Клиент

## 1. Общие положения

* **Транспорт:** WebRTC Data Channels
  * **Канал управления**: `control-channel`
  * **Каналы данных**: `proxy-*`
* **Формат данных:** JSON
* **Кодировка:** UTF-8

Процесс установления WebRTC-соединения между двумя участниками комнаты координируется сигнальным сервером (см. спецификацию Клиент-Сервер). Для предотвращения конфликтов (`glare`) инициатором соединения, отправляющим `SDP Offer`, **всегда** является участник, чей псевдоним является лексикографически **меньшим** (первым в алфавитном порядке).

## 2. Структуры сообщений управления

Сообщения управления передаются по каналу управления и отвечают за синхронизацию состояний клиентов и организацию каналов данных.

Сообщение к/от другому клиенту представляют собой JSON-объект, который должен содержать как минимум ключ `type`. Остальные поля зависят от типа сообщения.

```json
{
    "type": "MESSAGE_TYPE",
    "...": "..."
}
```

Ввиду симметричной природы протокола, каждый тип сообщения может быть как получен, так и отправлен.

Клиент должен использовать механику State (состояния) для общения по каналу управления, поскольку некоторые сообщения могут быть отправлены только после других или в ответ, необходимо это проверять, и не допускать Race Condition и подобных состояний.


## 3. Типы сообщений управления

### 3.1. Инициализация

Отправляется в начале WebRTC-соединения, каждый клиент отправляет подобное один раз и ожидает сообщение аналогичного формата от собеседника.

* **Поля:**
  * `type` (string): `"INIT"`
  * `IL_user` (string): Имя собеседника. Предназначается для противодействия MiTM-атаке на протокол.
  * `config` (obj): Хранит настройки клиентов для согласования:
    * `unreliable_channels` (bool): Включить UDP-like режим. Несовместим с продвинутым сжатием.
    * `compression_type` (str): Тип сжатия каналов с данными. Возможные: `"none"`, `"lz4"`, `"zlib"`, `"zlib-hc"`
    * `extended_compression` (bool): Включить режим сжатия на весь канал (хранить словарь сжатия для всего канала с данными, а не на каждый пакет отдельно). Невосместим с UDP-like режимом. Работает только с сжатием `zstd` и `zstd-hc`.
  * `ports` (list): Содержит список портов собеседника, к которым можно установить соединение
    * (string): Порт в формате `"12345:TCP"`

**Переданные для согласования клиентом настройки не могут быть изменены в контексте WebRTC-соединения после отправки сообщений инициализации.**

#### 3.1.1. Порядок согласования настроек

Порядок режимов сжатия. Если у клиенов различные настройки, выбирается режим с минимальным индексом:

0. `none`
1. `lz4`
2. `zstd`
3. `zstd-hc`

Если в результате согласования протокола один из клиентов предлагал `zstd` или `zstd-hc` с расширенным сжатием, но не был выбран ни один из этих вариантов, считать `extended_compression` выключенным, поскольку оно поддерживается лишь этими режимами.

Возможны различные варианты при согласовании настроек UDP-like режима и расширенного сжатия *(учтите, что расширенное сжатие могло быть отключено в результате согласования режима сжатия)*.

В случае, если согласовано применение обоих режимов, приоритет должен быть отдан расширенному сжатию. Если расширенное сжатие не согласовано, а согласован только UDP-like режим, лишь в этом случае тот может быть включён.

**Обратите внимание, что, хотя UDP-режим и расширенное сжатие несовместимы, в сообщении инициализации может быть допущено разрешение клиентом на использование обоих опций. В результате согласования должна быть выбрана только одна из них согласно приоритетам.**

### 3.2. Начало прокси-канала

Отправляется клиентом, который хочет установить соединение к одному из портов собеседника, указанных при инициализации.
Клиент, отправивший сообщение, должен ожидать ответа `FAILED` с причиной или `SUCCESS` в течении некоторого количества времени (TIMEOUT, >= 10 сек.), и затем, если оно не поступило, досрочно прервать установку канала отправкой `FAILED` с причиной `TIMEOUT`.

* **Поля:**
  * `type` (string): `"BEGIN_PROXY"`
  * `port` (integer): Целое число от 1 до 65535 (включительно).
  * `protocol` (string): `"TCP"` или `"UDP"`
  * `uuid` (string): строка в формате UUIDv4, с названием которой должен быть создан новый канал для передачи данных в случае успеха (`proxy-UUID`)

Собеседник обязан ответить на сообщение типом `SUCCESS` или `FAILED` (с указанием причины):

#### 3.2.1. Успех

Является ответом на запрос о начале прокси-канала. Не может быть самостоятельным запросом.

* **Поля**:
  * `type` (string): `"SUCCESS"`
  * `channel-name` (string): название в формате `proxy-UUID`, где UUID - переданный ранее `uuid`

После установления канала управление им переходит к правилам п.5 спецификации.

#### 3.2.2. Неудача

Ответ на запрос о начале прокси-канала, обозначающий что начать прокси-канал не удалось. Не может быть самостоятельным запросом.

* **Поля**:
  * `type` (string): `"FAILED"`
  * `channel-name` (string): название канала в формате `proxy-UUID`, в создании которого было отказано
  * `reason` (string): причина отказа

## 4. Валидация полей получаемых сообщений

- Поле `type` сообщения должно быть одним из: `"INIT"`, `"BEGIN_PROXY"`, `"SUCCESS"`, `"FAILED"`

### 4.1. Инициализация

* `IL_user` (string): содержит идентификатор клиента. Если он не совпадает, клиент обязан разорвать WebRTC-соединение.
* `config/unreliable_channels` (bool): если не указан, `false`
* `config/compression_type` (string): если не указан или неверен, `"none"`
* `config/extended_compression` (bool): если не указан, `false`
* `ports` (list/string): если не указан, считать пустым (`[]`). Неверные значения списка игнорировать.

### 4.2. Начало прокси-канала

* `port` (integer): если не входит в радиус 1-65535 (включительно), вернуть `FAILED` с ошибкой `INVALID_PORT`
* `protocol` (string): если не является `"TCP"` или `"UDP"`, вернуть `FAILED` с ошибкой `INVALID_PROTOCOL`
* `channel-name` (string): если не соответствует формату `proxy-UUID`, проигнорировать

Если сочетание `PORT:PROTO` не поддерживается для передачей клиентом, вернуть `FAILED` с ошибкой `ACCESS_DENIED`

#### 4.2.1. Формат названия канала

Если собеседник вернул `SUCCESS` с названием канала, отличным от формата `proxy-UUID`, такое сообщение должно игнорироваться.

## 5. Управление каналом данных

При начале, канал должен создаваться с настройками, согласованными при инициализации:
- **UDP-режим:** указывается `(ordered=False, maxRetransmits=0)`
- **Сжатие:** используется указанный режим:
  - `none`: сжатие отсутствует
  - `lz4`: по-пакетное сжатие `LZ4` с уровнем `1` для пакетов длиной больше 200 байт
  - `zstd`: по-пакетное (или по-канальное, если согласован расширенный режим) сжатие `Zstandard` с уровнем `3` для пакетов длиной более 200 байт.
  - `zstd-hc`: по-пакетное (или по-канальное, если согласован расширенный режим) сжатие `Zstandard` с уровнем `15` для пакетов длиной более 100 байт.

Дата-канал передаёт бинарные (BINARY) данные.

Далее управление дата-каналом переходит к его обработчику сообщений:
передаются пакеты с сокета, которые автоматически шифруются DTLS от WebRTC. В сообщении передаётся только "бит сжатия" первым байтом и далее содержимое пакета, сжатое согласно биту (если длина несжатого пакета удовлетворяла условию) или нет.
Бит сжатия отключён, если согласовано отсутствие (`none`) шифрования.

При закрытии дата-канала второй стороной клиентом автоматически должен быть закрыт loopback-сокет, с ним связанный, а также обработчик канала.

## 6. Дополнение. Вторичное шифрование ГОСТ 34.12-2018 "Кузнечик"

При включении опции, все проходящие по каналам данных пакеты дополнительно шифруются перед передачей в API WebRTC.
Шифрование соотвествующим шифром в режиме CTR, с вектором инициализации состоящим из первых (младших) 64 бит идентификатора (UUID) канала.

Ключом шифрования соответствующего канала является результат выполнения хэш Стрибог-256 от конкатенированных согласованного общего ключа и UUID канала
